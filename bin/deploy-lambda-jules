#!/bin/bash
# -----------------------------------------------------------------------------
# (C) Copyright 2019 British Crown (Met Office) & Contributors
# -----------------------------------------------------------------------------
set -eu
set -o pipefail

cfn-deploy() {
    local NAME="$1"
    shift 1
    echo "Deploy: ${NAME}"
    # --tags ... cannot be quoted or the format will mess up.
    # shellcheck disable=SC2046
    aws cloudformation deploy \
        --stack-name="${NAME}" \
        --template-file="${HERED}/cfn/${NAME}.cfn.yaml" \
        "$@" \
        --tags $(<"${HERED}/cfn/tags.txt")
}

if ! aws --version 1>'/dev/null'; then
    echo "Sorry, this script requires 'aws'." >&2
    exit 1
fi

LAMBDA_JULES_ZIP="${1:-./lambda-jules.zip}"
if [[ ! -f "${LAMBDA_JULES_ZIP}" ]]; then
    echo "${LAMBDA_JULES_ZIP} not found." >&2
    exit 1
fi

HERED="$(cd "$(dirname "$0")/.." && pwd)"

# Deploy
cfn-deploy 'zip-packs'
PACKAGE_BUCKET="$( \
    aws cloudformation list-exports \
    --output=text --query='Exports[?name=="zip-packs"].Value')"
aws s3 cp "${LAMBDA_JULES_ZIP}" "s3://${PACKAGE_BUCKET}/"
cfn-deploy 'lambda-jules' --capabilities='CAPABILITY_IAM'

exit
